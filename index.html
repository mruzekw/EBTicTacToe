<!DOCTYPE html>
<html>

  <head>
    <title>Tic-Tac-Toe</title>
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <hgroup>
      <h1 class="logo">Tic-Tac-Toe</h1>
      <h2>May the odds be ever in your favor.</h2>
    </hgroup>

    <div class="game-container">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.3.1/redux.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/4.4.0/react-redux.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>

    <script type="text/babel">
    (function () {

      /**
       * State of the board is reprsented by an array of tile states
       * A tile can be in three states:
       *   - Blank: null
       *   - X: 1
       *   - O: 2
       */

      let reducer = (previousState, action) => {
        switch (action.type) {
          case 'SET_PIECE':
            return Object.assign({}, previousState, {
              currentPlayer: previousState.currentPlayer === 1 ? 2 : 1,
              board: previousState.board.map((row, rowIdx) => {
                return rowIdx === action.row ?
                  row.map((col, colIdx) => {
                    return colIdx === action.col ? action.piece : col
                  }) :
                  row
              })
            });
          default:
            return previousState;
        }
      }
      
      function setPiece(row, col, piece) {
        return {
          type: 'SET_PIECE',
          row, col, piece
        }
      }

      let store = Redux.createStore(reducer, {
        board: generateSquareMatrix(3, null),
        currentPlayer: 1
      });

      // Log the initial state
      console.log(store.getState())

      let unsubscribe = store.subscribe(() =>
        console.log(store.getState())
      )

      class Tile extends React.Component {
        render() {
          return (
            <div className='ttt-tile' onClick={this.props.onClick}>
              {(() => {
                switch (this.props.piece) {
                  case 1:  return <div className='ttt-x-piece'></div>;
                  case 2:  return <div className='ttt-o-piece'></div>;
                  default: return '';
                }
              })()}
            </div>
          );
        }
      }

      class Board extends React.Component {
        render() {
          return (
            <div className='ttt-board'>
              {this.props.matrix.map(function (row, rowIdx) {
                return (
                  <div key={rowIdx} className="ttt-board-row">
                    {row.map(function (col, colIdx) {
                      return (
                        <Tile key={colIdx} 
                              piece={col}  
                              onClick={() => store.dispatch(setPiece(rowIdx, colIdx, this.props.currentPlayer))} />
                      );
                    }.bind(this))}
                  </div>
                ); 
              }.bind(this))}
            </div>
          );
        }
      }

      function generateSquareMatrix(num, value) {
        var arr = [], row, col;
        for(row = 0; row < num; row++) {
          arr[row] = [];
          for(col = 0; col < num; col++) {
            arr[row][col] = value;
          }
        }

        return arr;
      }

      var TicTacToe = ReactRedux.connect(
        function mapStateToProps(state) {
          return { matrix: state.board, ...state };
        }
      )(Board);

      ReactDOM.render(
        <ReactRedux.Provider store={store}>
          <TicTacToe />
        </ReactRedux.Provider>,
        document.querySelectorAll('.game-container')[0]
      )

    })();
    </script>

  </body>

</html>